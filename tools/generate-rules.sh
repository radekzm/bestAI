#!/bin/bash
# tools/generate-rules.sh â€” Generate tool-specific rules from bestAI config
# Usage: bash tools/generate-rules.sh [project-dir] --format cursor|windsurf|codex
# Outputs rules to stdout. Redirect to target file.
# Requires: jq (optional, for frozen-fragments parsing)

set -euo pipefail

TARGET="${1:-.}"
FORMAT=""
shift || true

while [ "$#" -gt 0 ]; do
    case "$1" in
        --format) FORMAT="${2:-}"; shift 2 ;;
        *) shift ;;
    esac
done

if [ -z "$FORMAT" ]; then
    echo "Usage: bash tools/generate-rules.sh [project-dir] --format cursor|windsurf|codex" >&2
    echo "Formats: cursor (.cursorrules), windsurf (.windsurfrules), codex (codex.md)" >&2
    exit 1
fi

if [ ! -d "$TARGET" ]; then
    echo "Error: $TARGET is not a directory." >&2
    exit 1
fi

PROJECT_DIR="$(cd "$TARGET" && pwd)"
PROJECT_KEY=$(echo "$PROJECT_DIR" | tr '/' '-')
MEMORY_DIR="$HOME/.claude/projects/$PROJECT_KEY/memory"
CLAUDE_MD="$PROJECT_DIR/CLAUDE.md"
AGENTS_MD="$PROJECT_DIR/AGENTS.md"

# Collect frozen paths
FROZEN_PATHS=""
for registry in "$MEMORY_DIR/frozen-fragments.md" "$PROJECT_DIR/.claude/frozen-fragments.md"; do
    [ -f "$registry" ] || continue
    while IFS= read -r line; do
        path=$(echo "$line" | sed -n 's/.*`\([^`]*\)`.*/\1/p' | head -1)
        [ -n "$path" ] && FROZEN_PATHS="$FROZEN_PATHS\n- $path"
    done < <(grep -E '^\s*-\s*`' "$registry" 2>/dev/null)
done

# Extract project info from CLAUDE.md
PROJECT_NAME=$(basename "$PROJECT_DIR")
STACK=""
if [ -f "$CLAUDE_MD" ]; then
    STACK=$(grep -iE 'stack|tech|framework' "$CLAUDE_MD" 2>/dev/null | head -3 | sed 's/^/# /' || true)
fi

# Generate header
gen_header() {
    echo "# Generated by bestAI tools/generate-rules.sh"
    echo "# Source: $PROJECT_NAME bestAI configuration"
    echo "# Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
    echo ""
}

# Generate frozen files section
gen_frozen() {
    if [ -n "$FROZEN_PATHS" ]; then
        echo "## Protected Files (DO NOT MODIFY)"
        echo ""
        echo "The following files are frozen and must not be edited:"
        echo -e "$FROZEN_PATHS"
        echo ""
        echo "If you need to modify a frozen file, ask the user for explicit permission first."
        echo ""
    fi
}

# Extract key rules from CLAUDE.md
gen_rules_from_claude_md() {
    if [ -f "$CLAUDE_MD" ]; then
        echo "## Project Guidelines"
        echo ""
        # Extract rules sections (## headings and their content)
        sed -n '/^## /,/^## /{ /^## /!{ /^$/!p } }' "$CLAUDE_MD" 2>/dev/null | head -50
        echo ""
    fi
}

# Extract from AGENTS.md if exists
gen_agents_section() {
    if [ -f "$AGENTS_MD" ]; then
        echo "## Cross-Tool Instructions (from AGENTS.md)"
        echo ""
        cat "$AGENTS_MD" | grep -v '^<!--' | head -60
        echo ""
    fi
}

case "$FORMAT" in
    cursor)
        gen_header
        echo "# .cursorrules for $PROJECT_NAME"
        echo ""
        gen_frozen
        gen_rules_from_claude_md
        echo "## bestAI Enforcement Note"
        echo ""
        echo "This file provides advisory rules only. For deterministic enforcement"
        echo "(frozen files, backup requirements), use bestAI hooks with Claude Code."
        echo "See: https://github.com/radekzm/bestAI"
        ;;
    windsurf)
        gen_header
        echo "# .windsurfrules for $PROJECT_NAME"
        echo ""
        gen_frozen
        gen_rules_from_claude_md
        echo "## bestAI Enforcement Note"
        echo ""
        echo "This file provides advisory rules only. For deterministic enforcement,"
        echo "use bestAI hooks with Claude Code."
        ;;
    codex)
        gen_header
        echo "# Codex instructions for $PROJECT_NAME"
        echo ""
        gen_frozen
        gen_agents_section
        gen_rules_from_claude_md
        ;;
    *)
        echo "Error: Unknown format '$FORMAT'. Use: cursor, windsurf, codex" >&2
        exit 1
        ;;
esac
